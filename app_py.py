# -*- coding: utf-8 -*-
"""app.py

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1fiycIrZOSa-981ZZG-5931XC1tzKYScY
"""

!pip install streamlit

# âœ… STEP 1: Install required libraries
!pip install pandas

# âœ… STEP 2: Upload multiple JSON files
from google.colab import files
uploaded = files.upload()  # upload multiple JSON files here

# âœ… STEP 3: Load and merge all JSON files
import pandas as pd
import json

dataframes = []

for filename in uploaded.keys():
    with open(filename, 'r') as file:
        json_data = json.load(file)
        df = pd.json_normalize(json_data)  # flatten nested JSON if needed
        dataframes.append(df)

# âœ… STEP 4: Concatenate into a single DataFrame
merged_df = pd.concat(dataframes, ignore_index=True)

# âœ… STEP 5: Preview the combined data
merged_df.head()

# âœ… STEP 6: Save as CSV (optional)
merged_df.to_csv("merged_data.csv", index=False)

# âœ… STEP 7: Or save as cleaned JSON
merged_df.to_json("merged_data.json", orient="records", indent=4)

# âœ… STEP 8: Download result
files.download("merged_data.csv")
files.download("merged_data.json")

import pandas as pd
import json

with open("merged_data.json") as f:
    data = json.load(f)

df = pd.json_normalize(data)

import streamlit as st
import pandas as pd
import plotly.express as px

st.set_page_config(page_title="ğŸ“± Mobile Promoter Dashboard", layout="wide")

# âœ… Load data
@st.cache_data
def load_data():
    return pd.read_json("merged_data.json")

df = load_data()

# âœ… Identify brand columns dynamically (assumes numeric types except Branch & Manager)
non_brand_cols = ["Branch", "Manager"]
brand_columns = [col for col in df.columns if col not in non_brand_cols and pd.api.types.is_numeric_dtype(df[col])]

# âœ… Sidebar filters
st.sidebar.header("ğŸ” Filters")
managers = st.sidebar.multiselect("Select Manager(s)", options=df["Manager"].unique(), default=df["Manager"].unique())

if not brand_columns:
    st.sidebar.warning("âš ï¸ No brand data found in file.")
brands = st.sidebar.multiselect("Select Brand(s)", options=brand_columns, default=brand_columns)

# âœ… Filter by manager
filtered_df = df[df["Manager"].isin(managers)]

# âœ… Safe KPI calculations
total_branches = filtered_df.shape[0]

if brands:
    total_promoters = filtered_df[brands].sum().sum()
    avg_per_branch = round(total_promoters / total_branches, 1) if total_branches > 0 else 0
else:
    total_promoters = 0
    avg_per_branch = 0

# âœ… KPI section
col1, col2, col3, col4 = st.columns(4)
col1.metric("ğŸ¢ Total Branches", total_branches)
col2.metric("ğŸ‘¥ Total Promoters", total_promoters)
col3.metric("ğŸ“ˆ Avg Promoters/Branch", avg_per_branch)
col4.metric("âœ… Active Managers", len(filtered_df['Manager'].unique()))

st.markdown("---")

# âœ… Charts â€” guarded by brand selection
if brands:
    st.subheader("ğŸ“Š Promoters by Brand")
    brand_totals = filtered_df[brands].sum().reset_index()
    brand_totals.columns = ["Brand", "Total"]
    st.plotly_chart(px.bar(brand_totals, x="Brand", y="Total", color="Brand"), use_container_width=True)

    st.subheader("ğŸ“Š Promoters by Manager")
    manager_totals = filtered_df.groupby("Manager")[brands].sum().sum(axis=1).reset_index(name="Total")
    st.plotly_chart(px.pie(manager_totals, names="Manager", values="Total"), use_container_width=True)

    # Top 10 branches
    top_df = filtered_df.copy()
    top_df["Total"] = top_df[brands].sum(axis=1)
    top_10 = top_df.sort_values("Total", ascending=False).head(10)
    st.subheader("ğŸ† Top 10 Branches by Total Promoters")
    st.plotly_chart(px.bar(top_10, x="Total", y="Branch", color="Manager", orientation="h"), use_container_width=True)

    # Heatmap
    st.subheader("ğŸ“Š Brand vs Manager Heatmap")
    heatmap_data = filtered_df.groupby("Manager")[brands].sum()
    st.plotly_chart(px.imshow(heatmap_data, text_auto=True, title="Brand Distribution"), use_container_width=True)

# âœ… Data Table
st.subheader("ğŸ“‹ Branch-Level Data")

if brands:
    filtered_df["Total"] = filtered_df[brands].sum(axis=1)

display_cols = [col for col in non_brand_cols + brands + (["Total"] if "Total" in filtered_df.columns else []) if col in filtered_df.columns]
st.dataframe(filtered_df[display_cols], use_container_width=True)

# âœ… Download Options
st.markdown("### ğŸ“¥ Download Filtered Data")
st.download_button("Download CSV", filtered_df.to_csv(index=False), file_name="filtered_data.csv")
st.download_button("Download JSON", filtered_df.to_json(orient="records", indent=4), file_name="filtered_data.json")

